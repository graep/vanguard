<ion-content class="planning-content">
  <div class="content-container">
    
    <!-- Loading State (only for daily view) -->
    <div *ngIf="isLoading && viewMode === 'daily'" class="loading-container">
      <ion-spinner color="success"></ion-spinner>
      <p>Loading daily plan...</p>
    </div>
    
    <!-- Main Content -->
    <div class="planning-container">
      
      <!-- Page Header -->
      <div class="page-header">
        <div class="header-content">
          <div>
            <h1 class="page-title">Planning</h1>
            <p class="page-subtitle">{{ getFormattedDate() }}</p>
          </div>
          <div class="controls-container">
            <!-- Daily View Controls -->
            <app-daily-view-controls
              *ngIf="viewMode === 'daily'"
              [selectedDate]="selectedDate"
              [isSaving]="isSaving"
              [hasCheckedAssignments]="hasCheckedAssignments()"
              [checkedCount]="getCheckedCount()"
              [isTodaySelected]="isTodaySelected()"
              [isTomorrowSelected]="isTomorrowSelected()"
              [workAssignments]="workAssignments"
              (dateChange)="onDateChange($event)"
              (selectToday)="selectToday()"
              (selectTomorrow)="selectTomorrow()"
              (openDatePicker)="openDatePicker()"
              (submitChecked)="submitCheckedAssignments()">
            </app-daily-view-controls>

            <!-- Weekly View Controls -->
            <app-weekly-view-controls
              *ngIf="viewMode === 'weekly'"
              [selectedDate]="selectedDate"
              [isTodaySelected]="isTodaySelected()"
              (dateChange)="onDateChange($event)"
              (selectToday)="selectToday()"
              (openDatePicker)="openDatePicker()">
            </app-weekly-view-controls>

            <!-- Monthly View Controls -->
            <app-monthly-view-controls
              *ngIf="viewMode === 'monthly'"
              [selectedDate]="selectedDate"
              [isTodaySelected]="isTodaySelected()"
              (dateChange)="onDateChange($event)"
              (selectToday)="selectToday()"
              (openDatePicker)="openDatePicker()">
            </app-monthly-view-controls>
          </div>
        </div>
      </div>
      
      <!-- Planning Spreadsheet -->
      <ion-card class="planning-card">
        <ion-card-header>
          <div class="card-header-content">
            <ion-card-title>
              <ion-icon name="grid-outline"></ion-icon>
              {{ getCardTitle() }}
            </ion-card-title>
            <div class="header-actions">
              <!-- View Mode Tabs -->
              <ion-segment [value]="viewMode" (ionChange)="setViewMode($any($event.detail.value))" class="view-mode-tabs">
                <ion-segment-button value="daily">
                  <ion-label>Daily</ion-label>
                </ion-segment-button>
                <ion-segment-button value="weekly">
                  <ion-label>Weekly</ion-label>
                </ion-segment-button>
                <ion-segment-button value="monthly">
                  <ion-label>Monthly</ion-label>
                </ion-segment-button>
              </ion-segment>
              <!-- Print Button -->
              <ion-button 
                fill="clear"
                size="small"
                color="primary"
                (click)="printPlan()"
                class="print-button">
                <ion-icon name="print-outline"></ion-icon>
              </ion-button>
              <ion-button 
                *ngIf="viewMode === 'daily' && hasMultipleWavesAssigned()"
                fill="outline"
                size="small"
                color="primary"
                (click)="toggleWaveGrouping()">
                <ion-icon [name]="isGroupedByWave ? 'eye-off-outline' : 'layers-outline'" slot="start"></ion-icon>
                {{ isGroupedByWave ? 'Ungroup' : 'Group' }}
              </ion-button>
            </div>
          </div>
        </ion-card-header>
        <ion-card-content>
          <!-- Daily View -->
          <div *ngIf="viewMode === 'daily'">
            <div *ngIf="!dailyPlan && !isLoading" class="empty-state">
              <p>No daily plan available. Please select a date.</p>
            </div>
            <div *ngIf="isLoading && viewMode === 'daily'" class="loading-container">
              <ion-spinner color="success"></ion-spinner>
              <p>Loading daily plan...</p>
            </div>
            <div *ngIf="dailyPlan && !isLoading" class="assignment-table">
            <div class="table-header">
              <div class="col-checkbox">
                <ion-checkbox 
                  [checked]="isAllCompletedChecked()"
                  [indeterminate]="isSomeCompletedChecked() && !isAllCompletedChecked()"
                  (ionChange)="toggleAllCompleted($event.detail.checked)">
                </ion-checkbox>
              </div>
              <div class="col-van">Van</div>
              <div class="col-driver">Driver</div>
              <div class="col-route">Route</div>
              <div class="col-staging">Stage</div>
              <div class="col-wave">Wave</div>
              <div class="col-pad">Pad</div>
              <div class="col-notes">Notes</div>
              <div class="col-clear"></div>
              <div class="col-stats">
                <ion-chip 
                  [color]="stats.totalUnassigned > 0 ? 'danger' : 'success'" 
                  class="stats-chip">
                  <ion-icon [name]="stats.totalUnassigned > 0 ? 'alert-circle' : 'checkmark-circle'"></ion-icon>
                  <ion-label>
                    {{ stats.totalAssigned }}/{{ stats.totalAssigned + stats.totalUnassigned }} Assigned
                  </ion-label>
                </ion-chip>
              </div>
            </div>
            <div class="table-body" [class.dropdown-active]="isDropdownActive()">
              <ng-container *ngFor="let group of getGroupedAssignmentsByWave(); let groupIndex = index; trackBy: trackByGroupIndex">
                <!-- Wave Group Separator (for all groups) -->
                <div *ngIf="isGroupedByWave && group.wave !== null" class="wave-group-separator">
                  <div class="separator-label">Wave {{ group.wave }}</div>
                </div>
                
                <!-- Assignments in this wave group -->
                <div 
                  class="table-row" 
                  *ngFor="let assignment of group.assignments; let i = index; trackBy: trackByAssignmentId"
                [class.unassigned]="isUnassigned(assignment) && !isAssignmentEditing(assignment.id || '')"
                [class.editing]="isAssignmentEditing(assignment.id || '') && !isUnassigned(assignment)"
                [class.has-van]="assignment.vanId && assignment.vanId.trim() !== ''"
                [class.completed]="isCompleted(assignment) || (isAssignmentEditing(assignment.id || '') && isUnassigned(assignment))"
                [class.clickable]="!isAssignmentEditing(assignment.id || '')"
                [class.wave-1]="getWaveNumber(assignment) === 1"
                [class.wave-2]="getWaveNumber(assignment) === 2"
                [class.wave-3]="getWaveNumber(assignment) === 3"
                (click)="handleRowClick(assignment)">
                
                <!-- Checkbox - Only show when route is unrouted (no driver) -->
                <div class="col-checkbox" (click)="$event.stopPropagation()">
                  <ion-checkbox 
                    *ngIf="hasAllInformation(assignment) && isUnassigned(assignment)"
                    [checked]="isChecked(assignment.id || '')"
                    (ionChange)="toggleChecked(assignment.id || '', $event.detail.checked)">
                  </ion-checkbox>
                </div>
                
                <!-- Van (read-only) -->
                <div class="col-van">
                  <span [class.has-value]="assignment.vanId && assignment.vanId.trim() !== ''">
                    {{ assignment.vanId && assignment.vanId.trim() !== '' ? (assignment.vanType + ' ' + assignment.vanNumber) : '+ Add Van' }}
                  </span>
                </div>
                
                <!-- Driver (editable) -->
                <div class="col-driver" (click)="isAssignmentEditing(assignment.id || '') && $event.stopPropagation()">
                  <div *ngIf="isAssignmentEditing(assignment.id || '')" class="driver-autocomplete" (click)="$event.stopPropagation()">
                    <ion-input 
                      #driverInput
                      [value]="getEditingValue(assignment.id || '', 'driverName')"
                      (ionInput)="filterDriverName(assignment.id || '', $any($event).detail.value)"
                      (keydown)="handleDriverKeydown(assignment.id || '', $event)"
                      (ionFocus)="positionDropdown($event.target, assignment.id || '')"
                      placeholder="Search driver"
                      (click)="$event.stopPropagation()">
                    </ion-input>
                  </div>
                  <span *ngIf="!isAssignmentEditing(assignment.id || '')" 
                        [class.empty]="isUnassigned(assignment)">
                    {{ assignment.driverName || 'Unrouted' }}
                  </span>
                </div>
                
                <!-- Route -->
                <div class="col-route" (click)="isAssignmentEditing(assignment.id || '') && $event.stopPropagation()">
                  <ion-input 
                    *ngIf="isAssignmentEditing(assignment.id || '')"
                    [value]="getEditingValue(assignment.id || '', 'routeNumber')"
                    (ionInput)="updateEditingValue(assignment.id || '', 'routeNumber', $event.detail.value)"
                    placeholder="CX...">
                  </ion-input>
                  <span *ngIf="!isAssignmentEditing(assignment.id || '')">
                    {{ assignment.routeNumber || '-' }}
                  </span>
                </div>
                
                <!-- Staging -->
                <div class="col-staging" (click)="isAssignmentEditing(assignment.id || '') && $event.stopPropagation()">
                  <ion-input 
                    *ngIf="isAssignmentEditing(assignment.id || '')"
                    [value]="getEditingValue(assignment.id || '', 'staging')"
                    (ionInput)="updateEditingValue(assignment.id || '', 'staging', $event.detail.value)"
                    (ionBlur)="formatStaging(assignment.id || '')"
                    placeholder="E.1">
                  </ion-input>
                  <span *ngIf="!isAssignmentEditing(assignment.id || '')">
                    {{ assignment.staging || '-' }}
                  </span>
                </div>
                
                <!-- Wave -->
                <div class="col-wave" (click)="isAssignmentEditing(assignment.id || '') && $event.stopPropagation()">
                  <ion-input 
                    *ngIf="isAssignmentEditing(assignment.id || '')"
                    type="number"
                    [value]="getEditingValue(assignment.id || '', 'wave')"
                    (ionInput)="updateEditingValue(assignment.id || '', 'wave', $event.detail.value)"
                    (ionBlur)="validateWave(assignment.id || '')"
                    placeholder="Wave"
                    min="1"
                    max="3"
                    (click)="$event.stopPropagation()">
                  </ion-input>
                  <span *ngIf="!isAssignmentEditing(assignment.id || '')">
                    {{ assignment.wave || '-' }}
                  </span>
                </div>
                
                <!-- Pad -->
                <div class="col-pad" (click)="isAssignmentEditing(assignment.id || '') && $event.stopPropagation()">
                  <ion-input 
                    *ngIf="isAssignmentEditing(assignment.id || '')"
                    type="number"
                    [value]="getEditingValue(assignment.id || '', 'pad')"
                    (ionInput)="updateEditingValue(assignment.id || '', 'pad', $event.detail.value)"
                    (ionBlur)="validatePad(assignment.id || '')"
                    placeholder="Pad"
                    min="1"
                    max="3"
                    (click)="$event.stopPropagation()">
                  </ion-input>
                  <span *ngIf="!isAssignmentEditing(assignment.id || '')">
                    {{ assignment.pad || '-' }}
                  </span>
                </div>
                
                <!-- Notes -->
                <div class="col-notes" (click)="isAssignmentEditing(assignment.id || '') && $event.stopPropagation()">
                  <ion-input 
                    *ngIf="isAssignmentEditing(assignment.id || '') && isNotesEditing(assignment.id || '')"
                    [value]="getEditingValue(assignment.id || '', 'notes')"
                    (ionInput)="updateEditingValue(assignment.id || '', 'notes', $any($event).detail.value)"
                    (ionBlur)="cancelEditingNotes(assignment.id || '')"
                    (keydown)="handleNotesKeydown(assignment.id || '', $event, i)"
                    placeholder="Notes">
                  </ion-input>
                  <ion-button 
                    *ngIf="isAssignmentEditing(assignment.id || '') && !isNotesEditing(assignment.id || '') && !assignment.notes"
                    fill="clear"
                    size="small"
                    color="medium"
                    (click)="startEditingNotes(assignment.id || '')"
                    (keydown)="handleAddNotesButtonKeydown(assignment.id || '', $event, i)"
                    tabindex="0"
                    title="Add notes">
                    <ion-icon name="add"></ion-icon>
                  </ion-button>
                  <span *ngIf="!isAssignmentEditing(assignment.id || '') || (!isNotesEditing(assignment.id || '') && assignment.notes)">
                    {{ assignment.notes || '-' }}
                  </span>
                </div>
                
                <!-- Clear/Save Buttons -->
                <div class="col-clear" (click)="$event.stopPropagation()">
                  <!-- Save and Cancel buttons when editing -->
                  <div *ngIf="isAssignmentEditing(assignment.id || '')" class="edit-actions">
                    <ion-button
                      fill="clear"
                      size="small"
                      color="success"
                      (click)="$event.stopPropagation(); saveAssignment(assignment.id || '')"
                      title="Save changes">
                      <ion-icon name="checkmark"></ion-icon>
                    </ion-button>
                    <ion-button
                      fill="clear"
                      size="small"
                      color="medium"
                      (click)="$event.stopPropagation(); cancelEditing(assignment.id || '')"
                      title="Cancel editing">
                      <ion-icon name="close"></ion-icon>
                    </ion-button>
                  </div>
                  <!-- Clear button when not editing -->
                  <ion-button
                    *ngIf="!isAssignmentEditing(assignment.id || '')"
                    fill="clear"
                    size="small"
                    color="danger"
                    (click)="$event.stopPropagation(); clearAssignmentData(assignment.id || '')"
                    title="Clear assignment">
                    <ion-icon name="close"></ion-icon>
                  </ion-button>
                </div>
                
                <!-- Stats column (empty for rows) -->
                <div class="col-stats"></div>
                </div>
              </ng-container>
            </div>
          </div>
          </div>
          
          <!-- Weekly View -->
          <div *ngIf="viewMode === 'weekly'" class="weekly-view">
            <div *ngIf="isLoading" class="loading-container">
              <ion-spinner color="success"></ion-spinner>
              <p>Loading weekly plans...</p>
            </div>
            <ng-container *ngIf="!isLoading">
              <div class="weekly-header">
                <div class="week-day-header" *ngFor="let day of getWeekDays(); trackBy: trackByDate">
                  <div class="day-label">{{ getWeekDayLabel(day) }}</div>
                  <div class="day-date">{{ getWeekDayFullLabel(day) }}</div>
                </div>
              </div>
              <div class="weekly-content">
                <div class="week-day-column" *ngFor="let day of getWeekDays(); trackBy: trackByDate">
                  <div class="day-assignments">
                    <ng-container *ngIf="getPlanForDate(day)?.assignments && getPlanForDate(day)!.assignments.length > 0">
                      <div 
                        *ngFor="let assignment of getPlanForDate(day)!.assignments; trackBy: trackByAssignmentId"
                        class="assignment-card"
                        [class.unassigned]="isUnassigned(assignment)">
                        <div class="assignment-van">{{ assignment.vanType }} {{ assignment.vanNumber }}</div>
                        <div class="assignment-driver">{{ assignment.driverName || 'Unrouted' }}</div>
                        <div class="assignment-route" *ngIf="assignment.routeNumber">{{ assignment.routeNumber }}</div>
                      </div>
                    </ng-container>
                    <div *ngIf="!getPlanForDate(day) || !getPlanForDate(day)?.assignments || getPlanForDate(day)!.assignments.length === 0" class="no-assignments">
                      No assignments
                    </div>
                  </div>
                </div>
              </div>
            </ng-container>
          </div>
          
          <!-- Monthly View -->
          <div *ngIf="viewMode === 'monthly'" class="monthly-view">
            <div *ngIf="isLoading" class="loading-container">
              <ion-spinner color="success"></ion-spinner>
              <p>Loading monthly plans...</p>
            </div>
            <ng-container *ngIf="!isLoading">
              <div class="monthly-header">
                <div class="month-day-header" *ngFor="let dayLabel of ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat']">
                  {{ dayLabel }}
                </div>
              </div>
              <div class="monthly-grid">
                <div 
                  class="month-day-cell"
                  [class.empty]="day.isEmpty"
                  [class.today]="!day.isEmpty && day.date === getTodayDateString()"
                  *ngFor="let day of getMonthlyDays(); trackBy: trackByMonthlyDay">
                  <div *ngIf="!day.isEmpty" class="day-content">
                    <div class="day-number">{{ getMonthlyDayLabel(day.date) }}</div>
                    <div class="day-assignments-count">
                      {{ (getPlanForDate(day.date)?.assignments?.length || 0) }} route(s)
                    </div>
                    <div class="day-assigned-count" *ngIf="getPlanForDate(day.date)">
                      {{ getAssignedCount(day.date) }} assigned
                    </div>
                  </div>
                </div>
              </div>
            </ng-container>
          </div>
        </ion-card-content>
      </ion-card>
      
    </div>
  </div>
</ion-content>
