<ion-content class="user-review-content">
  <!-- Page Header with Breadcrumb and Logout -->
  <app-page-header 
    [breadcrumbItems]="breadcrumbItems" 
    (logout)="logout()">
  </app-page-header>
  
  <div class="user-review-container">
    <!-- Hero Section -->
    <div class="hero-section">
      <div class="hero-content">
        <h1 class="hero-title">{{ vanType }} {{ vanNumber }}</h1>
        <p class="hero-subtitle">Complete your inspection by reporting any issues found</p>
        <div class="inspection-status">
          <ion-icon name="checkmark-circle" class="status-icon"></ion-icon>
          <span class="status-text">Photos captured successfully</span>
        </div>
      </div>
    </div>

    <!-- No Issues and Unsure Cards -->
    <div class="top-cards-container">
      <!-- No Issues Card -->
      <div class="no-issues-card" (click)="toggleNoIssues()">
        <div class="card-header">
          <div class="card-icon">
            <ion-icon name="checkmark-circle"></ion-icon>
          </div>
          <div class="card-content">
            <h3 class="card-title">No Issues Found</h3>
            <p class="card-description">Check this if no issues were found during inspection</p>
          </div>
        </div>
        <ion-checkbox
          [(ngModel)]="noIssues"
          class="main-checkbox"
          (click)="$event.stopPropagation()">
        </ion-checkbox>
      </div>

      <!-- Unsure Issues Card -->
      <div class="unsure-card" (click)="toggleUnsureIssue()">
        <div class="card-header">
          <div class="card-icon unsure-icon">
            <ion-icon name="help-circle"></ion-icon>
          </div>
          <div class="card-content">
            <h3 class="card-title">Unsure About Something?</h3>
            <p class="card-description">Report something you're uncertain about</p>
          </div>
        </div>
        <ion-checkbox
          [(ngModel)]="unsureIssue.hasIssue"
          class="main-checkbox"
          (click)="$event.stopPropagation()">
        </ion-checkbox>
      </div>
    </div>

    <!-- Unsure Issue Details -->
    <div class="unsure-details" *ngIf="unsureIssue.hasIssue && !noIssues">
      <div class="unsure-details-card">
        <div class="details-section">
          <label class="form-label">Describe what you observed</label>
          <ion-textarea
            [(ngModel)]="unsureIssue.details"
            placeholder="Describe what you observed or are concerned about"
            auto-grow="true"
            class="details-textarea"
            (ionFocus)="onFormElementFocus()"
            (ionBlur)="onFormElementBlur()">
          </ion-textarea>
        </div>

        <!-- Photo Capture Section -->
        <div class="photo-capture-section">
          <label class="form-label">Take a photo (optional)</label>
          
          <!-- Photo Display Area -->
          <div class="photo-display-area" *ngIf="unsureIssue.capturedPhoto; else noPhotoTemplate">
            <div class="photo-container">
              <img [src]="unsureIssue.capturedPhoto" alt="Captured issue photo" class="issue-photo">
              <div class="photo-overlay">
                <ion-button
                  fill="solid"
                  class="retake-button"
                  (click)="capturePhoto()">
                  <ion-icon name="camera" slot="start"></ion-icon>
                  Retake
                </ion-button>
                <ion-button
                  fill="clear"
                  class="delete-button"
                  (click)="removePhoto()">
                  <ion-icon name="trash"></ion-icon>
                </ion-button>
              </div>
            </div>
          </div>
          
          <!-- No Photo Template -->
          <ng-template #noPhotoTemplate>
            <ion-button
              fill="outline"
              class="photo-capture-button"
              (click)="capturePhoto()">
              <ion-icon name="camera" slot="start"></ion-icon>
              Take Photo
            </ion-button>
          </ng-template>
        </div>
      </div>
    </div>

    <!-- Issue Categories Section -->
    <div class="categories-section" *ngIf="!noIssues">
      <div class="section-header">
        <h2 class="section-title">Report Issues by Category</h2>
        <p class="section-subtitle">Select any categories where issues were found</p>
      </div>

      <div class="categories-container">
        <div *ngFor="let cat of issueCategories" 
             class="category-card" 
             [class.selected]="cat.hasIssue"
             (click)="toggleCategory(cat)">
          <div class="category-header">
            <div class="category-icon" [class]="'severity-' + cat.severity">
              <ion-icon [name]="getCategoryIcon(cat.name)"></ion-icon>
            </div>
            <div class="category-info">
              <h3 class="category-title">{{ cat.name }}</h3>
              <p class="category-severity">{{ cat.severity | titlecase }} Priority</p>
            </div>
            <ion-checkbox
              [(ngModel)]="cat.hasIssue"
              class="category-checkbox"
              (click)="$event.stopPropagation()">
            </ion-checkbox>
          </div>

          <!-- Issue Details (shown when category is selected) -->
          <div class="issue-details" *ngIf="cat.hasIssue" (click)="$event.stopPropagation()">
            <!-- Subcategory Selection -->
            <div class="subcategory-section" *ngIf="cat.subcategories?.length">
              <label class="form-label">Which area?</label>
              <ion-select
                [(ngModel)]="cat.selectedSubcategory"
                placeholder="Select specific area"
                class="subcategory-select"
                (click)="$event.stopPropagation()"
                (ionFocus)="onFormElementFocus()"
                (ionBlur)="onFormElementBlur()">
                <ion-select-option
                  *ngFor="let sub of cat.subcategories"
                  [value]="sub">
                  {{ sub }}
                </ion-select-option>
              </ion-select>
            </div>

            <!-- Details Textarea -->
            <div class="details-section">
              <label class="form-label">Describe the issue</label>
              <ion-textarea
                [(ngModel)]="cat.details"
                [placeholder]="'Describe issues with ' + (cat.selectedSubcategory || cat.name)"
                auto-grow="true"
                class="details-textarea"
                (click)="$event.stopPropagation()"
                (ionFocus)="onFormElementFocus()"
                (ionBlur)="onFormElementBlur()">
              </ion-textarea>
            </div>

            <!-- Photo Capture Section -->
            <div class="photo-capture-section" *ngIf="cat.allowPhotoCapture">
              <label class="form-label">Take a photo (optional)</label>
              
              <!-- Photo Display Area -->
              <div class="photo-display-area" *ngIf="cat.capturedPhoto; else noCategoryPhotoTemplate">
                <div class="photo-container">
                  <img [src]="cat.capturedPhoto" alt="Captured issue photo" class="issue-photo">
                  <div class="photo-overlay">
                    <ion-button
                      fill="solid"
                      class="retake-button"
                      (click)="capturePhoto(cat)">
                      <ion-icon name="camera" slot="start"></ion-icon>
                      Retake
                    </ion-button>
                    <ion-button
                      fill="clear"
                      class="delete-button"
                      (click)="removePhoto(cat)">
                      <ion-icon name="trash"></ion-icon>
                    </ion-button>
                  </div>
                </div>
              </div>
              
              <!-- No Photo Template -->
              <ng-template #noCategoryPhotoTemplate>
                <ion-button
                  fill="outline"
                  class="photo-capture-button"
                  (click)="capturePhoto(cat)">
                  <ion-icon name="camera" slot="start"></ion-icon>
                  Take Photo
                </ion-button>
              </ng-template>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Submit Button -->
    <div class="submit-section">
      <ion-button
        class="submit-button"
        (click)="submitReview()"
        [disabled]="!canSubmit"
        expand="block">
        <ion-icon name="checkmark-circle" slot="start"></ion-icon>
        Submit Review
      </ion-button>
    </div>
  </div>
</ion-content>
